<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Empresa - Sistema de Pr√°cticas</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="assets/logo.svg" alt="Logo" class="sidebar-logo">
                <span class="sidebar-title">Empresa</span>
            </div>
            <nav class="sidebar-nav">
                <a href="#myoffers" class="sidebar-link active" data-section="myoffers">
                    <span class="sidebar-icon">üìã</span>
                    <span>Mis Ofertas</span>
                </a>
                <a href="#createoffer" class="sidebar-link" data-section="createoffer">
                    <span class="sidebar-icon">‚ûï</span>
                    <span>Publicar Oferta</span>
                </a>
                <a href="#applicants" class="sidebar-link" data-section="applicants">
                    <span class="sidebar-icon">üë•</span>
                    <span>Postulantes</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn btn-text btn-block">Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <main class="dashboard-main">
            <header class="dashboard-header">
                <h1 id="sectionTitle">Mis Ofertas</h1>
                <div class="user-info">
                    <span id="userName">Empresa</span>
                    <span class="user-role">Empresa</span>
                </div>
            </header>

            <!-- Mis Ofertas Section -->
            <section id="myoffersSection" class="dashboard-section active">
                <div class="section-actions">
                    <input type="text" id="offerSearch" class="search-input" placeholder="Buscar mis ofertas...">
                    <select id="statusFilter" class="filter-select">
                        <option value="">Todos los estados</option>
                        <option value="pending">Pendientes</option>
                        <option value="approved">Aprobadas</option>
                        <option value="rejected">Rechazadas</option>
                    </select>
                </div>

                <!-- Metrics Row (visible solo en Mis Ofertas) -->
                <div class="container mt-3">
                    <div class="metrics-grid" id="companyMetrics">
                        <div class="metric-card metric-card-blue">
                            <div class="metric-icon-wrapper">üìÑ</div>
                            <div class="metric-content">
                                <p class="metric-label">Ofertas publicadas</p>
                                <p class="metric-value" id="metricOffers">0</p>
                                <p class="metric-subtext">Total de ofertas creadas por la empresa</p>
                            </div>
                        </div>

                        <div class="metric-card metric-card-green">
                            <div class="metric-icon-wrapper">üë•</div>
                            <div class="metric-content">
                                <p class="metric-label">Postulantes</p>
                                <p class="metric-value" id="metricApplicants">0</p>
                                <p class="metric-subtext">Postulaciones totales a tus ofertas</p>
                            </div>
                        </div>

                        <div class="metric-card metric-card-yellow">
                            <div class="metric-icon-wrapper">‚úÖ</div>
                            <div class="metric-content">
                                <p class="metric-label">Ofertas activas</p>
                                <p class="metric-value" id="metricActive">0</p>
                                <p class="metric-subtext">Ofertas con estado aprobadas</p>
                            </div>
                        </div>

                        <div class="metric-card metric-card-purple">
                            <div class="metric-icon-wrapper">‚è≥</div>
                            <div class="metric-content">
                                <p class="metric-label">Pendientes</p>
                                <p class="metric-value" id="metricPending">0</p>
                                <p class="metric-subtext">Ofertas en revisi√≥n</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="offersGrid" class="offers-grid">
                    <!-- Se carga din√°micamente -->
                </div>
            </section>

            <!-- Crear Oferta Section -->
            <section id="createofferSection" class="dashboard-section">
                <div class="card">
                    <h2 class="card-title">Publicar Nueva Oferta</h2>
                    <div class="card-grid">
                        <form id="createOfferForm" class="create-offer-form" aria-label="Formulario publicar oferta">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="title" class="form-label">üìã T√≠tulo de la Oferta *</label>
                                    <input type="text" id="title" class="form-input" required placeholder="Ej: Desarrollador Junior">
                                    <span class="form-help">S√© claro y conciso. Ej: "Desarrollador Frontend - React"</span>
                                </div>
                                <div class="form-group">
                                    <label for="type" class="form-label">üè∑Ô∏è Tipo *</label>
                                    <div class="custom-select-wrapper">
                                        <button type="button" class="custom-select-input" id="typeButton">
                                            <span id="typeValue">Seleccionar</span>
                                            <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'></polyline></svg>
                                        </button>
                                        <select id="type" class="custom-select-hidden" required>
                                            <option value="">Seleccionar</option>
                                            <option value="Pasant√≠a">Pasant√≠a</option>
                                            <option value="Pr√°ctica">Pr√°ctica</option>
                                            <option value="Proyecto">Proyecto</option>
                                        </select>
                                        <div class="custom-select-dropdown" id="typeDropdown">
                                            <div class="custom-option" data-value="">Seleccionar</div>
                                            <div class="custom-option" data-value="Pasant√≠a">Pasant√≠a</div>
                                            <div class="custom-option" data-value="Pr√°ctica">Pr√°ctica</div>
                                            <div class="custom-option" data-value="Proyecto">Proyecto</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="career" class="form-label">üéì Carrera *</label>
                                    <div class="custom-select-wrapper">
                                        <button type="button" class="custom-select-input" id="careerButton">
                                            <span id="careerValue">Seleccionar</span>
                                            <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'></polyline></svg>
                                        </button>
                                        <select id="career" class="custom-select-hidden" required>
                                            <option value="">Seleccionar</option>
                                            <option value="Ingenier√≠a de Sistemas">Ingenier√≠a de Sistemas</option>
                                            <option value="Ingenier√≠a Industrial">Ingenier√≠a Industrial</option>
                                            <option value="Tecnolog√≠a en Desarrollo de Software">Tecnolog√≠a en Desarrollo de Software</option>
                                            <option value="Tecnolog√≠a en Gesti√≥n Administrativa">Tecnolog√≠a en Gesti√≥n Administrativa</option>
                                        </select>
                                        <div class="custom-select-dropdown" id="careerDropdown">
                                            <div class="custom-option" data-value="">Seleccionar</div>
                                            <div class="custom-option" data-value="Ingenier√≠a de Sistemas">Ingenier√≠a de Sistemas</div>
                                            <div class="custom-option" data-value="Ingenier√≠a Industrial">Ingenier√≠a Industrial</div>
                                            <div class="custom-option" data-value="Tecnolog√≠a en Desarrollo de Software">Tecnolog√≠a en Desarrollo de Software</div>
                                            <div class="custom-option" data-value="Tecnolog√≠a en Gesti√≥n Administrativa">Tecnolog√≠a en Gesti√≥n Administrativa</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="deadline" class="form-label">üìÖ Fecha L√≠mite *</label>
                                    <div class="date-picker-wrapper">
                                        <input type="text" id="deadline" class="form-input date-picker-input" required placeholder="Selecciona una fecha" readonly>
                                        <div class="date-picker-calendar" id="datePickerCalendar">
                                            <div class="calendar-header">
                                                <button type="button" class="calendar-nav calendar-prev" id="calendarPrev">‚ùÆ</button>
                                                <div class="calendar-month-year" id="calendarMonthYear"></div>
                                                <button type="button" class="calendar-nav calendar-next" id="calendarNext">‚ùØ</button>
                                            </div>
                                            <div class="calendar-weekdays">
                                                <div>Dom</div>
                                                <div>Lun</div>
                                                <div>Mar</div>
                                                <div>Mi√©</div>
                                                <div>Jue</div>
                                                <div>Vie</div>
                                                <div>Sab</div>
                                            </div>
                                            <div class="calendar-days" id="calendarDays"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="description" class="form-label">‚úçÔ∏è Descripci√≥n *</label>
                                <textarea id="description" class="form-input" rows="6" required placeholder="Describe las responsabilidades y actividades..."></textarea>
                                <span class="form-help">Incluye tareas, herramientas y valor diferencial.</span>
                            </div>

                            <div class="form-group">
                                <label for="requirements" class="form-label">‚ö° Requisitos *</label>
                                <textarea id="requirements" class="form-input" rows="4" required placeholder="Lista los requisitos necesarios..."></textarea>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary" id="submitOfferBtn">Publicar Oferta</button>
                                <button type="reset" class="btn btn-secondary" id="resetFormBtn">Limpiar</button>
                            </div>
                        </form>

                        <!-- Vista previa de la oferta -->
                        <aside class="offer-preview" aria-hidden="false">
                            <h3 class="card-title" style="margin-top:0;">Vista previa</h3>
                            <div class="offer-card">
                                <div class="offer-header">
                                    <h3 class="offer-title" id="previewTitle">T√≠tulo de la oferta</h3>
                                    <span class="offer-company" id="previewType">Tipo</span>
                                </div>
                                <div class="offer-body">
                                    <div class="offer-detail">
                                        <div class="offer-detail-content">
                                            <p class="offer-detail-label">Carrera</p>
                                            <p class="offer-detail-value" id="previewCareer">No especificado</p>
                                        </div>
                                    </div>

                                    <p class="offer-description" id="previewDescription">Resumen breve de la oferta aparecer√° aqu√≠ cuando completes la descripci√≥n.</p>
                                </div>

                                <div class="offer-footer">
                                    <span class="offer-status status-pending" id="previewStatus">Pendiente</span>
                                    <div>
                                        <small class="form-help">Fecha l√≠mite: <span id="previewDeadline">-</span></small>
                                    </div>
                                </div>
                            </div>
                        </aside>
                    </div>
                </div>
            </section>

            <!-- Postulantes Section -->
            <section id="applicantsSection" class="dashboard-section">
                <div class="applicants-header">
                    <h2 class="card-title" style="margin:0;">Postulantes</h2>
                    <div class="applicants-filters">
                        <div class="filter-wrapper">
                            <select id="offerSelectFilter" class="filter-select">
                                <option value="">Todas las ofertas</option>
                            </select>
                        </div>
                        <div class="filter-wrapper">
                            <select id="applicantStatusFilter" class="filter-select">
                                <option value="">Todos los estados</option>
                                <option value="pending">Pendientes</option>
                                <option value="company_accepted">Aceptados</option>
                                <option value="company_rejected">Rechazados</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="applicantsContainer" class="applicants-grid">
                    <!-- Se carga din√°micamente -->
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Ver Postulante -->
    <div id="applicantModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div id="applicantDetailContent">
                <!-- Se carga din√°micamente -->
            </div>
        </div>
    </div>

    <div id="notification"></div>

    <script src="js/mockData.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/offers.js"></script>
    <script src="js/applications.js"></script>
    <script>
        let currentUser;

        document.addEventListener('DOMContentLoaded', () => {
            initializeMockData();
            requireAuth('company');
            
            currentUser = getCurrentUser();
            document.getElementById('userName').textContent = currentUser.name;
            
            setupNavigation();
            loadMyOffers();
            setMinDate();
            setupDatePicker();
            setupCustomSelects();
            
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('createOfferForm').addEventListener('submit', handleCreateOffer);
            document.getElementById('offerSearch').addEventListener('input', loadMyOffers);
            document.getElementById('statusFilter').addEventListener('change', loadMyOffers);
            document.getElementById('offerSelectFilter').addEventListener('change', loadApplicants);
            document.getElementById('applicantStatusFilter').addEventListener('change', loadApplicants);
            // Actualizar m√©tricas iniciales
            updateMetrics();
                // Inicializar vista previa del formulario
                setupOfferPreview();
        });

        function setupNavigation() {
            const links = document.querySelectorAll('.sidebar-link');
            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    showSection(section);
                    
                    links.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });
        }

        function showSection(sectionName) {
            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach(s => s.classList.remove('active'));
            
            const section = document.getElementById(sectionName + 'Section');
            if (section) {
                section.classList.add('active');
                
                const titles = {
                    'myoffers': 'Mis Ofertas',
                    'createoffer': 'Publicar Oferta',
                    'applicants': 'Postulantes'
                };
                document.getElementById('sectionTitle').textContent = titles[sectionName];
                
                if (sectionName === 'myoffers') loadMyOffers();
                if (sectionName === 'applicants') {
                    loadOffersForFilter();
                    loadApplicants();
                }
            }
        }

        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deadline').min = today;
        }

        async function loadMyOffers() {
            try {
                const search = document.getElementById('offerSearch').value;
                const status = document.getElementById('statusFilter').value;
                
                const offers = await apiGetOffers({ company_id: currentUser.id, search, status });
                renderMyOffers(offers);
                // actualizar m√©tricas relacionadas con ofertas
                updateMetrics(offers);
            } catch (error) {
                showNotification('Error al cargar ofertas', 'error');
            }
        }

        function renderMyOffers(offers) {
            const grid = document.getElementById('offersGrid');
            if (offers.length === 0) {
                grid.innerHTML = '<p class="empty-state">No tienes ofertas publicadas</p>';
                return;
            }
            
            grid.innerHTML = offers.map(offer => `
                <div class="offer-card">
                    <div class="offer-header">
                        <h3 class="offer-title">${offer.title}</h3>
                        <span class="badge badge-${offer.status}">${getStatusLabel(offer.status)}</span>
                    </div>
                    <div class="offer-meta">
                        <span>üìö ${offer.career}</span>
                        <span>üìÖ ${formatDate(offer.deadline)}</span>
                        <span>üë• ${offer.applicants_count || 0} postulantes</span>
                    </div>
                    <div class="offer-description">${truncate(offer.description, 100)}</div>
                    <div class="offer-actions">
                        <button class="btn btn-sm btn-primary" onclick="viewOfferApplicants(${offer.id})">Ver Postulantes</button>
                        <button class="btn btn-sm btn-secondary" onclick="editOffer(${offer.id})">Editar</button>
                        ${offer.status === 'pending' || offer.status === 'approved' ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteOffer(${offer.id})">Eliminar</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function handleCreateOffer(e) {
            e.preventDefault();
            
            const title = document.getElementById('title').value.trim();
            const type = document.getElementById('type').value;
            const career = document.getElementById('career').value;
            const deadline = document.getElementById('deadline').value;
            const description = document.getElementById('description').value.trim();
            const requirements = document.getElementById('requirements').value.trim();
            
            // Validar fecha l√≠mite
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selectedDate = new Date(deadline);
            
            if (selectedDate <= today) {
                showNotification('La fecha l√≠mite debe ser mayor a la fecha actual', 'error');
                return;
            }
            
            const offerData = {
                title,
                type,
                career,
                deadline,
                description,
                requirements,
                company_id: currentUser.id,
                company_name: currentUser.name,
                status: 'pending'
            };
            
            const submitBtn = document.getElementById('submitOfferBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Publicando...';
            
            try {
                await apiCreateOffer(offerData);
                showNotification('Oferta publicada exitosamente. Pendiente de aprobaci√≥n por admin.', 'success');
                document.getElementById('createOfferForm').reset();
                showSection('myoffers');
            } catch (error) {
                showNotification(error.message || 'Error al publicar oferta', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Publicar Oferta';
            }
        }

        function viewOfferApplicants(offerId) {
            showSection('applicants');
            document.getElementById('offerSelectFilter').value = offerId;
            loadApplicants();
        }

        async function loadOffersForFilter() {
            try {
                const offers = await apiGetOffers({ company_id: currentUser.id });
                const select = document.getElementById('offerSelectFilter');
                select.innerHTML = '<option value="">Todas las ofertas</option>' +
                    offers.map(o => `<option value="${o.id}">${o.title}</option>`).join('');
            } catch (error) {
                console.error('Error loading offers for filter:', error);
            }
        }

        async function loadApplicants() {
            try {
                const offerId = document.getElementById('offerSelectFilter').value;
                const status = document.getElementById('applicantStatusFilter').value;
                
                let applications = [];
                if (offerId) {
                    applications = await apiGetOfferApplicants(offerId);
                } else {
                    // Cargar todas las aplicaciones de todas las ofertas de la empresa
                    const offers = await apiGetOffers({ company_id: currentUser.id });
                    for (const offer of offers) {
                        const apps = await apiGetOfferApplicants(offer.id);
                        applications.push(...apps);
                    }
                }
                
                if (status) {
                    applications = applications.filter(app => app.status === status);
                }
                
                renderApplicants(applications);
                // actualizar m√©tricas relacionadas con postulantes
                updateMetrics(undefined, applications);
            } catch (error) {
                showNotification('Error al cargar postulantes', 'error');
            }
        }

        function renderApplicants(applications) {
            const container = document.getElementById('applicantsContainer');
            if (applications.length === 0) {
                container.innerHTML = '<div class="empty-state-modern"><p>üë• No hay postulantes que coincidan con los filtros</p></div>';
                return;
            }
            
            container.innerHTML = applications.map(app => {
                const statusClass = `status-${app.status}`;
                const statusLabel = getStatusLabel(app.status);
                return `
                    <div class="applicant-card modern">
                        <div class="applicant-card-header">
                            <div class="applicant-avatar-modern">${app.student_name?.charAt(0)?.toUpperCase() || 'üë§'}</div>
                            <div class="applicant-card-title">
                                <h3 class="applicant-name">${app.student_name}</h3>
                                <p class="applicant-offer">üìã ${app.offer_title}</p>
                            </div>
                            <span class="badge ${statusClass}">${statusLabel}</span>
                        </div>

                        <div class="applicant-card-body">
                            <div class="applicant-detail">
                                <span class="detail-label">üéì Carrera:</span>
                                <span class="detail-value">${app.profile_snapshot?.career || 'No especificado'}</span>
                            </div>
                            <div class="applicant-detail">
                                <span class="detail-label">üìß Email:</span>
                                <span class="detail-value">${app.profile_snapshot?.email || '-'}</span>
                            </div>
                            <div class="applicant-detail">
                                <span class="detail-label">üì± Tel√©fono:</span>
                                <span class="detail-value">${app.profile_snapshot?.phone || '-'}</span>
                            </div>
                            <div class="applicant-detail">
                                <span class="detail-label">üìÖ Aplic√≥:</span>
                                <span class="detail-value">${formatDate(app.applied_at)}</span>
                            </div>
                        </div>

                        <div class="applicant-card-actions">
                            ${app.status === 'pending' ? `
                                <button class="btn btn-sm btn-primary" onclick="acceptApplicant(${app.id})">‚úì Aceptar</button>
                                <button class="btn btn-sm btn-danger" onclick="rejectApplicant(${app.id})">‚úï Rechazar</button>
                            ` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="viewApplicantDetail(${app.id})">üëÅÔ∏è Detalle</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function acceptApplicant(appId) {
            if (!confirm('¬øAceptar este postulante? El admin deber√° aprobar y asignar un profesor.')) return;
            
            try {
                await apiCompanyReviewApplication(appId, { status: 'company_accepted' });
                showNotification('Postulante aceptado. Pendiente de revisi√≥n del admin.', 'success');
                loadApplicants();
            } catch (error) {
                showNotification('Error al aceptar postulante', 'error');
            }
        }

        async function rejectApplicant(appId) {
            if (!confirm('¬øRechazar este postulante?')) return;
            
            try {
                await apiCompanyReviewApplication(appId, { status: 'company_rejected' });
                showNotification('Postulante rechazado', 'success');
                loadApplicants();
            } catch (error) {
                showNotification('Error al rechazar postulante', 'error');
            }
        }

        function viewApplicantDetail(appId) {
            showNotification('Vista detallada en desarrollo', 'info');
        }

        function editOffer(offerId) {
            showNotification('Edici√≥n de ofertas en desarrollo', 'info');
        }

        async function deleteOffer(offerId) {
            if (!confirm('¬øEliminar esta oferta? Esta acci√≥n no se puede deshacer.')) return;
            
            try {
                await apiDeleteOffer(offerId);
                showNotification('Oferta eliminada', 'success');
                loadMyOffers();
            } catch (error) {
                showNotification('Error al eliminar oferta', 'error');
            }
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pendiente',
                'approved': 'Aprobada',
                'rejected': 'Rechazada',
                'company_accepted': 'Aceptada',
                'company_rejected': 'Rechazada'
            };
            return labels[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO');
        }

        function truncate(text, length) {
            if (!text) return '';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        // Actualiza las m√©tricas en la fila superior
        function updateMetrics(offersList, applicantsList) {
            // Si no se pasa offersList, intentar obtenerlas v√≠a API (silencioso)
            (async () => {
                try {
                    let offers = offersList;
                    if (!offers) offers = await apiGetOffers({ company_id: currentUser.id }) || [];

                    let applications = applicantsList;
                    if (!applications) {
                        applications = [];
                        for (const o of offers) {
                            const apps = await apiGetOfferApplicants(o.id);
                            applications.push(...apps);
                        }
                    }

                    const totalOffers = offers.length;
                    const totalApplicants = applications.length;
                    const totalActive = offers.filter(o => o.status === 'approved').length;
                    const totalPending = offers.filter(o => o.status === 'pending').length;

                    document.getElementById('metricOffers').textContent = totalOffers;
                    document.getElementById('metricApplicants').textContent = totalApplicants;
                    document.getElementById('metricActive').textContent = totalActive;
                    document.getElementById('metricPending').textContent = totalPending;
                } catch (e) {
                    // No bloquear la UI por m√©tricas
                    console.warn('No se pudieron actualizar m√©tricas', e);
                }
            })();
        }

        // Setup calendar personalizado para fecha l√≠mite
        function setupDatePicker() {
            const dateInput = document.getElementById('deadline');
            const calendar = document.getElementById('datePickerCalendar');
            const calendarDays = document.getElementById('calendarDays');
            const calendarMonthYear = document.getElementById('calendarMonthYear');
            const calendarPrev = document.getElementById('calendarPrev');
            const calendarNext = document.getElementById('calendarNext');

            let currentDate = new Date();

            function renderCalendar() {
                calendarDays.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                calendarMonthYear.textContent = currentDate.toLocaleDateString('es-CO', { month: 'long', year: 'numeric' }).toUpperCase();

                const firstDay = new Date(year, month, 1).getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();
                const prevLastDate = new Date(year, month, 0).getDate();

                // D√≠as del mes anterior
                for (let i = firstDay - 1; i >= 0; i--) {
                    const day = document.createElement('div');
                    day.className = 'calendar-day other-month';
                    day.textContent = prevLastDate - i;
                    calendarDays.appendChild(day);
                }

                // D√≠as del mes actual
                const today = new Date();
                for (let i = 1; i <= lastDate; i++) {
                    const day = document.createElement('div');
                    day.className = 'calendar-day';
                    day.textContent = i;

                    const thisDate = new Date(year, month, i);
                    const isToday = thisDate.toDateString() === today.toDateString();
                    const isSelected = dateInput.value && thisDate.toDateString() === new Date(dateInput.value).toDateString();
                    const isPast = thisDate < new Date(today.getFullYear(), today.getMonth(), today.getDate());

                    if (isToday) day.classList.add('today');
                    if (isSelected) day.classList.add('selected');
                    if (isPast) day.classList.add('disabled');

                    if (!isPast) {
                        day.addEventListener('click', () => {
                            dateInput.value = thisDate.toISOString().split('T')[0];
                            calendar.classList.remove('active');
                            updatePreview();
                            renderCalendar();
                        });
                    }

                    calendarDays.appendChild(day);
                }

                // D√≠as del mes siguiente
                const totalCells = calendarDays.children.length;
                const remainingCells = 42 - totalCells;
                for (let i = 1; i <= remainingCells; i++) {
                    const day = document.createElement('div');
                    day.className = 'calendar-day other-month';
                    day.textContent = i;
                    calendarDays.appendChild(day);
                }
            }

            dateInput.addEventListener('click', () => {
                calendar.classList.toggle('active');
            });

            calendarPrev.addEventListener('click', (e) => {
                e.preventDefault();
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            calendarNext.addEventListener('click', (e) => {
                e.preventDefault();
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            // Cerrar al hacer click fuera
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.date-picker-wrapper')) {
                    calendar.classList.remove('active');
                }
            });

            renderCalendar();
        }

        // Funci√≥n auxiliar para actualizar preview
        function updatePreview() {
            const description = document.getElementById('description');
            if (description) description.dispatchEvent(new Event('input'));
        }

        // Setup custom select: desplegables personalizados para Tipo y Carrera
        function setupCustomSelects() {
            const selects = [
                { hidden: 'type', button: 'typeButton', dropdown: 'typeDropdown', value: 'typeValue' },
                { hidden: 'career', button: 'careerButton', dropdown: 'careerDropdown', value: 'careerValue' }
            ];

            selects.forEach(config => {
                const hiddenSelect = document.getElementById(config.hidden);
                const button = document.getElementById(config.button);
                const dropdown = document.getElementById(config.dropdown);
                const valueSpan = document.getElementById(config.value);
                const options = dropdown.querySelectorAll('.custom-option');

                // Abrir/cerrar dropdown
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const isOpen = dropdown.classList.contains('active');
                    closeAllSelects();
                    if (!isOpen) {
                        dropdown.classList.add('active');
                        button.classList.add('active');
                    }
                });

                // Seleccionar opci√≥n
                options.forEach(option => {
                    option.addEventListener('click', () => {
                        const value = option.getAttribute('data-value');
                        hiddenSelect.value = value;
                        valueSpan.textContent = option.textContent;

                        // Actualizar visual
                        options.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');

                        // Cerrar dropdown
                        dropdown.classList.remove('active');
                        button.classList.remove('active');

                        // Trigger change event
                        hiddenSelect.dispatchEvent(new Event('change', { bubbles: true }));
                        
                        // Actualizar preview
                        updatePreview();
                    });
                });

                // Inicializar seleccionado
                const selectedOption = dropdown.querySelector(`[data-value="${hiddenSelect.value}"]`);
                if (selectedOption && hiddenSelect.value) {
                    selectedOption.classList.add('selected');
                    valueSpan.textContent = selectedOption.textContent;
                }
            });

            // Cerrar selects al hacer click fuera
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-select-wrapper')) {
                    closeAllSelects();
                }
            });

            function closeAllSelects() {
                document.querySelectorAll('.custom-select-dropdown').forEach(d => d.classList.remove('active'));
                document.querySelectorAll('.custom-select-input').forEach(b => b.classList.remove('active'));
            }
        }

        // Setup preview: sincronizar inputs con la vista previa en tiempo real
        function setupOfferPreview() {
            const title = document.getElementById('title');
            const type = document.getElementById('type');
            const career = document.getElementById('career');
            const deadline = document.getElementById('deadline');
            const description = document.getElementById('description');

            function refresh() {
                const t = title?.value || 'T√≠tulo de la oferta';
                const ty = type?.value || 'Tipo';
                const c = career?.value || 'No especificado';
                const d = description?.value || 'Resumen breve de la oferta aparecer√° aqu√≠ cuando completes la descripci√≥n.';
                const dl = deadline?.value ? new Date(deadline.value).toLocaleDateString('es-CO') : '-';

                const pTitle = document.getElementById('previewTitle');
                const pType = document.getElementById('previewType');
                const pCareer = document.getElementById('previewCareer');
                const pDesc = document.getElementById('previewDescription');
                const pDeadline = document.getElementById('previewDeadline');
                const pStatus = document.getElementById('previewStatus');

                if (pTitle) pTitle.textContent = t;
                if (pType) pType.textContent = ty;
                if (pCareer) pCareer.textContent = c;
                if (pDesc) pDesc.textContent = d.length > 220 ? d.substring(0,220) + '...' : d;
                if (pDeadline) pDeadline.textContent = dl;
                if (pStatus) pStatus.textContent = 'Pendiente';
            }

            [title, type, career, deadline, description].forEach(el => {
                if (!el) return;
                el.addEventListener('input', refresh);
                el.addEventListener('change', refresh);
            });

            // reset preview when the form is reset
            const resetBtn = document.getElementById('resetFormBtn');
            if (resetBtn) resetBtn.addEventListener('click', () => setTimeout(refresh, 10));

            // initial refresh
            setTimeout(refresh, 50);
        }
    </script>
</body>
</html>