<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - BlumeApp</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        // Habilitar modo oscuro si est√° configurado
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <!-- Notificaci√≥n -->
    <div id="notification" class="hidden fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm"></div>
    
    <!-- Men√∫ m√≥vil -->
    <div class="lg:hidden fixed top-4 left-4 z-40">
        <button id="mobileMenuButton" class="p-2 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>
    <div class="dashboard-layout min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out" role="navigation" aria-label="Men√∫ lateral">
            <div class="sidebar-header">
                <div class="flex items-center space-x-3">
                    <img src="assets/logo.png" alt="Logo" class="sidebar-logo w-10 h-10">
                    <div>
                        <h1 class="sidebar-title text-xl font-bold">BlumeApp</h1>
                        <div class="mt-3">
                            <label for="globalSearch" class="sr-only">Buscar</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input id="globalSearch" type="text" placeholder="Buscar..." class="search-input form-input pl-10" aria-label="Buscar">
                            </div>
                        </div>
                    </div>
                </div>
                <button id="closeSidebar" class="lg:hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav space-y-1">
                <a href="#metrics" class="sidebar-link group active" data-section="metrics">
                    <span class="sidebar-icon group-hover:bg-blue-100 dark:group-hover:bg-blue-900">
                        <i class="fas fa-chart-line"></i>
                    </span>
                    <span>M√©tricas</span>
                </a>
                <a href="#users" class="sidebar-link group" data-section="users">
                    <span class="sidebar-icon group-hover:bg-blue-100 dark:group-hover:bg-blue-900">
                        <i class="fas fa-users"></i>
                    </span>
                    <span>Usuarios</span>
                </a>
                <a href="#offers" class="sidebar-link group" data-section="offers">
                    <span class="sidebar-icon group-hover:bg-blue-100 dark:group-hover:bg-blue-900">
                        <i class="fas fa-briefcase"></i>
                    </span>
                    <span>Ofertas</span>
                </a>
                <a href="#applications" class="sidebar-link group" data-section="applications">
                    <span class="sidebar-icon group-hover:bg-blue-100 dark:group-hover:bg-blue-900">
                        <i class="fas fa-file-alt"></i>
                    </span>
                    <span>Postulaciones</span>
                </a>
                
                </a>
            </nav>
            
            <div class="sidebar-footer mt-auto p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
                            <i class="fas fa-user text-blue-600 dark:text-blue-300"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900 dark:text-white" id="userName">Admin</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Administrador</p>
                        </div>
                    </div>
                    <div class="flex items-center" title="Tema">
                        <label for="themeSelect" class="sr-only">Tema</label>
                        <select id="themeSelect" class="filter-select" aria-label="Seleccionar tema">
                            <option value="system">Sistema (predeterminado)</option>
                            <option value="light">Claro</option>
                            <option value="dark">Oscuro</option>
                        </select>
                    </div>
                </div>
                <button id="logoutBtn" class="mt-4 w-full btn btn-outline">
                    <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesi√≥n
                </button>
                <button id="toggleSidebarCollapse" class="mt-2 w-full btn btn-text" aria-label="Colapsar men√∫" title="Colapsar men√∫">
                    <i class="fas fa-angle-double-left"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Header -->
            <header class="dashboard-header bg-white dark:bg-gray-800 shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white" id="sectionTitle">Panel de Administraci√≥n</h1>
                        <!-- Breadcrumbs removidas para reducir espacio; se muestra s√≥lo el t√≠tulo -->
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <!-- Mantener √≠cono de notificaciones solo (la b√∫squeda se movi√≥ al sidebar) -->
                            <button id="headerNotifications" class="p-1 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-label="Notificaciones">
                                <i class="fas fa-bell text-xl"></i>
                                <span class="absolute top-0 right-0 h-3 w-3 rounded-full bg-red-500" aria-hidden="true"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- M√©tricas Section -->
            <section id="metricsSection" class="dashboard-section active p-6">
                <div class="metrics-grid">
                    <!-- Tarjeta de Total de Usuarios -->
                    <div class="metric-card metric-card-blue">
                        <div class="metric-icon-wrapper">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-label">Total de Usuarios</h3>
                            <p class="metric-value" id="metricUsers">0</p>
                            <p class="metric-change positive">
                                <i class="fas fa-arrow-up"></i> 12% m√°s
                            </p>
                        </div>
                    </div>

                    <!-- Tarjeta de Ofertas Pendientes -->
                    <div class="metric-card metric-card-yellow">
                        <div class="metric-icon-wrapper">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-label">Ofertas Pendientes</h3>
                            <p class="metric-value" id="metricOffers">0</p>
                            <a href="#offers" class="metric-link">
                                Revisar <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Tarjeta de Pr√°cticas en Curso -->
                    <div class="metric-card metric-card-green">
                        <div class="metric-icon-wrapper">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-label">Pr√°cticas en Curso</h3>
                            <p class="metric-value" id="metricPractices">0</p>
                            <div class="metric-progress">
                                <div class="metric-progress-bar" style="width: 65%"></div>
                            </div>
                            <p class="metric-subtext">65% avance promedio</p>
                        </div>
                    </div>

                    <!-- Tarjeta de Postulaciones Activas -->
                    <div class="metric-card metric-card-purple">
                        <div class="metric-icon-wrapper">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-label">Postulaciones Activas</h3>
                            <p class="metric-value" id="metricApplications">0</p>
                            <a href="#applications" class="metric-link">
                                Ver m√°s <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Gr√°fico de Actividad - Ocupa 2/3 del ancho -->
                    <div class="activity-chart-card lg:col-span-3">
                        <div class="activity-chart-header">
                            <div>
                                <h2 class="activity-chart-title">Actividad General</h2>
                                <p class="activity-chart-subtitle">Tendencia de actividades en la plataforma</p>
                            </div>
                            <div class="chart-filter">
                                <select class="chart-select">
                                    <option>√öltimos 7 d√≠as</option>
                                    <option>√öltimos 30 d√≠as</option>
                                    <option>Este a√±o</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="activity-chart-content">
                            <div class="chart-placeholder">
                                <div class="chart-bars">
                                    <div class="chart-bar" style="height: 60%;"><span>Mon</span></div>
                                    <div class="chart-bar" style="height: 75%;"><span>Tue</span></div>
                                    <div class="chart-bar" style="height: 45%;"><span>Wed</span></div>
                                    <div class="chart-bar" style="height: 85%;"><span>Thu</span></div>
                                    <div class="chart-bar" style="height: 55%;"><span>Fri</span></div>
                                    <div class="chart-bar" style="height: 70%;"><span>Sat</span></div>
                                    <div class="chart-bar" style="height: 50%;"><span>Sun</span></div>
                                </div>
                            </div>
                            
                            <div class="chart-stats">
                                <div class="chart-stat">
                                    <div class="stat-dot" style="background: linear-gradient(135deg, #004D7B, #00B2C1);"></div>
                                    <div>
                                        <p class="stat-label">Total de Eventos</p>
                                        <p class="stat-value">1,234</p>
                                    </div>
                                </div>
                                <div class="chart-stat">
                                    <div class="stat-dot" style="background: linear-gradient(135deg, #10B981, #22C55E);"></div>
                                    <div>
                                        <p class="stat-label">Promedio Diario</p>
                                        <p class="stat-value">176</p>
                                    </div>
                                </div>
                                <div class="chart-stat">
                                    <div class="stat-dot" style="background: linear-gradient(135deg, #F59E0B, #FB923C);"></div>
                                    <div>
                                        <p class="stat-label">Pico M√°s Alto</p>
                                        <p class="stat-value">287</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actividad Reciente - Ocupa 1/3 del ancho -->
                    <div class="activity-sidebar-card lg:col-span-1">
                        <div class="activity-sidebar-header">
                            <h2 class="activity-sidebar-title">√öltimas Actividades</h2>
                            <a href="#" class="activity-sidebar-link">Ver todo</a>
                        </div>
                        
                        <div id="recentActivity" class="activity-sidebar-list">
                            <!-- Actividad 1 -->
                            <div class="activity-sidebar-item activity-success">
                                <div class="activity-sidebar-icon">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="activity-sidebar-content">
                                    <h4 class="activity-sidebar-item-title">Nueva oferta aprobada</h4>
                                    <p class="activity-sidebar-time">Hace 2 horas</p>
                                </div>
                            </div>
                            
                            <!-- Actividad 2 -->
                            <div class="activity-sidebar-item activity-info">
                                <div class="activity-sidebar-icon">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div class="activity-sidebar-content">
                                    <h4 class="activity-sidebar-item-title">Nuevo usuario registrado</h4>
                                    <p class="activity-sidebar-time">Hace 5 horas</p>
                                </div>
                            </div>
                            
                            <!-- Actividad 3 -->
                            <div class="activity-sidebar-item activity-warning">
                                <div class="activity-sidebar-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="activity-sidebar-content">
                                    <h4 class="activity-sidebar-item-title">Acci√≥n requerida</h4>
                                    <p class="activity-sidebar-time">Hace 1 d√≠a</p>
                                </div>
                            </div>
                            
                            <!-- Actividad 4 -->
                            <div class="activity-sidebar-item activity-default">
                                <div class="activity-sidebar-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="activity-sidebar-content">
                                    <h4 class="activity-sidebar-item-title">Nueva postulaci√≥n</h4>
                                    <p class="activity-sidebar-time">Ayer</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="activity-sidebar-footer">
                            <a href="#" class="activity-sidebar-load-more">
                                Cargar m√°s <i class="fas fa-chevron-down"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Usuarios Section -->
            <section id="usersSection" class="dashboard-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Gesti√≥n de Usuarios</h2>
                        <p class="section-subtitle">Administra todos los usuarios del sistema</p>
                    </div>
                    <button class="btn btn-primary" onclick="openAddUserModal()">
                        <i class="fas fa-plus mr-2"></i>Nuevo Usuario
                    </button>
                </div>

                <div class="section-controls">
                    <div class="search-box-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" id="userSearch" class="search-box" placeholder="Buscar por nombre, email...">
                    </div>
                    <select id="roleFilter" class="filter-select">
                        <option value="">Todos los roles</option>
                        <option value="student">Estudiantes</option>
                        <option value="company">Empresas</option>
                        <option value="teacher">Profesores</option>
                    </select>
                </div>

                <div class="users-card">
                    <div class="table-responsive">
                        <table class="table table-users">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Se carga din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Ofertas Section -->
            <section id="offersSection" class="dashboard-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Gesti√≥n de Ofertas</h2>
                        <p class="section-subtitle">Revisa y gestiona todas las ofertas de pr√°cticas</p>
                    </div>
                    <button class="btn btn-primary" onclick="openAddOfferModal()">
                        <i class="fas fa-plus mr-2"></i>Nueva Oferta
                    </button>
                </div>

                <div class="section-controls">
                    <div class="search-box-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" id="offerSearch" class="search-box" placeholder="Buscar por empresa, puesto...">
                    </div>
                    <select id="offerStatusFilter" class="filter-select">
                        <option value="">Todos los estados</option>
                        <option value="pending">Pendientes</option>
                        <option value="approved">Aprobadas</option>
                        <option value="rejected">Rechazadas</option>
                    </select>
                </div>

                <div id="offersGrid" class="offers-grid">
                    <!-- Se carga din√°micamente -->
                </div>
            </section>

            <!-- Postulaciones Section -->
            <section id="applicationsSection" class="dashboard-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Postulaciones</h2>
                        <p class="section-subtitle">Gestiona todas las postulaciones a ofertas</p>
                    </div>
                </div>

                <div class="section-controls">
                    <div class="search-box-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" id="applicationSearch" class="search-box" placeholder="Buscar por estudiante, oferta...">
                    </div>
                    <select id="applicationStatusFilter" class="filter-select">
                        <option value="">Todos los estados</option>
                        <option value="pending">Pendientes</option>
                        <option value="company_accepted">Empresa Acept√≥</option>
                        <option value="company_rejected">Empresa Rechaz√≥</option>
                        <option value="approved">Aprobadas</option>
                        <option value="rejected">Rechazadas</option>
                    </select>
                </div>

                <div class="users-card">
                    <div class="table-responsive">
                        <table class="table table-applications">
                            <thead>
                                <tr>
                                    <th>NO</th>
                                    <th>Nombre</th>
                                    <th>Oferta</th>
                                    <th>Empresa</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="applicationsTableBody">
                                <!-- Se carga din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Asignar Profesor -->
    <div id="assignTeacherModal" class="modal fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <div class="absolute top-0 right-0 pt-4 pr-4">
                    <button type="button" class="bg-white dark:bg-gray-800 rounded-md text-gray-400 hover:text-gray-500 focus:outline-none" id="closeAssignTeacherModal">
                        <span class="sr-only">Cerrar</span>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div>
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900">
                        <i class="fas fa-chalkboard-teacher text-blue-600 dark:text-blue-300"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-5">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                            Asignar Profesor
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                Selecciona un profesor para asignar a esta pr√°ctica.
                            </p>
                        </div>
                        
                        <form id="assignTeacherForm" class="mt-4" onsubmit="return false;">
                            <div class="mb-3">
                                <label for="teacherSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Profesor</label>
                                <select id="teacherSelect" aria-label="Seleccionar profesor" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="">Seleccionar profesor</option>
                                    <!-- Se llenar√° din√°micamente -->
                                </select>
                                <p class="mt-2 text-sm text-red-600 hidden" id="teacherError" role="alert" aria-live="assertive">Por favor selecciona un profesor.</p>
                            </div>

                            <div class="mb-3">
                                <label for="assignedDate" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Fecha de asignaci√≥n</label>
                                <input type="date" id="assignedDate" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            </div>

                            <div class="mb-3">
                                <label for="assignedNotes" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Notas (opcional)</label>
                                <textarea id="assignedNotes" rows="3" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Comentarios para el profesor o la pr√°ctica"></textarea>
                            </div>

                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="notifyStudent" />
                                <label for="notifyStudent" class="text-sm text-gray-700 dark:text-gray-300">Notificar al estudiante por correo</label>
                            </div>

                            <input type="hidden" id="applicationId" value="">
                        </form>
                    </div>
                </div>
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                    <button type="button" id="confirmAssignTeacher" disabled class="w-full inline-flex justify-center items-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:col-start-2 sm:text-sm">
                        <span id="confirmAssignText">Asignar</span>
                        <span id="confirmAssignSpinner" class="ml-2 hidden" aria-hidden="true">‚è≥</span>
                    </button>
                    <button type="button" id="cancelAssignTeacher" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
   <!-- Scripts de la aplicaci√≥n -->
<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script src="js/mockData.js"></script>
<script src="js/ui.js"></script>
<script src="js/offers.js"></script>

<!-- Script de inicializaci√≥n -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar componentes
        setupMobileMenu();
        setupDarkMode();
        setupNavigation();
        initializeTooltips();
        setupSidebarCollapse();
        // Inicializar datos mock si aplica
        if (typeof initializeMockData === 'function') initializeMockData();
        
        // Cargar datos iniciales
        loadMetrics();
        loadUsers();
        loadOffers();
        loadApplications();
        // Eventos globales
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) logoutBtn.addEventListener('click', function() { if (typeof logout === 'function') logout(); });

        const confirmAssign = document.getElementById('confirmAssignTeacher');
        if (confirmAssign) confirmAssign.addEventListener('click', handleAssignTeacher);
        const cancelAssign = document.getElementById('cancelAssignTeacher');
        if (cancelAssign) cancelAssign.addEventListener('click', function() { closeModal('assignTeacherModal'); });
        const assignForm = document.getElementById('assignTeacherForm');
        if (assignForm) assignForm.addEventListener('submit', handleAssignTeacher);
    });
    
    function setupMobileMenu() {
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const closeSidebar = document.getElementById('closeSidebar');
            const sidebar = document.getElementById('sidebar');
            
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', function() {
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('translate-x-0');
                });
            }
            
            if (closeSidebar) {
                closeSidebar.addEventListener('click', function() {
                    sidebar.classList.remove('translate-x-0');
                    sidebar.classList.add('-translate-x-full');
                });
            }
            
            // Cerrar men√∫ al hacer clic en un enlace en m√≥viles
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth < 1024) {
                        sidebar.classList.remove('translate-x-0');
                        sidebar.classList.add('-translate-x-full');
                    }
                });
            });
        }
        
        function applyTheme(theme) {
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else if (theme === 'light') {
                document.documentElement.classList.remove('dark');
            } else { // system
                if (prefersDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }
        }

        function setupDarkMode() {
            const themeSelect = document.getElementById('themeSelect');
            const stored = localStorage.getItem('theme') || 'system';
            // set select value
            if (themeSelect) themeSelect.value = stored;

            // apply initial theme
            applyTheme(stored);

            // react to user changes
            if (themeSelect) {
                themeSelect.addEventListener('change', function() {
                    const value = this.value;
                    localStorage.setItem('theme', value);
                    applyTheme(value);
                });
            }

            // if user chose 'system', listen for OS changes and update
            if (window.matchMedia) {
                const mql = window.matchMedia('(prefers-color-scheme: dark)');
                mql.addEventListener ? mql.addEventListener('change', (e) => {
                    const current = localStorage.getItem('theme') || 'system';
                    if (current === 'system') applyTheme('system');
                }) : mql.addListener((e) => {
                    const current = localStorage.getItem('theme') || 'system';
                    if (current === 'system') applyTheme('system');
                });
            }
        }
        
        function initializeTooltips() {
            // Inicializar tooltips con tippy.js o similar si es necesario
        }

        function setupSidebarCollapse() {
            const toggle = document.getElementById('toggleSidebarCollapse');
            const sidebar = document.getElementById('sidebar');
            const layout = document.querySelector('.dashboard-layout');
            if (!toggle || !sidebar || !layout) return;

            toggle.addEventListener('click', function() {
                const collapsed = sidebar.classList.toggle('collapsed');
                layout.classList.toggle('sidebar-collapsed', collapsed);
                // Actualizar icono y aria
                const icon = toggle.querySelector('i');
                if (icon) {
                    if (collapsed) {
                        icon.classList.remove('fa-angle-double-left');
                        icon.classList.add('fa-angle-double-right');
                        toggle.setAttribute('title', 'Expandir men√∫');
                        toggle.setAttribute('aria-label', 'Expandir men√∫');
                    } else {
                        icon.classList.remove('fa-angle-double-right');
                        icon.classList.add('fa-angle-double-left');
                        toggle.setAttribute('title', 'Colapsar men√∫');
                        toggle.setAttribute('aria-label', 'Colapsar men√∫');
                    }
                }
            });

            // Atajo de teclado: 'm' para alternar (si no estamos escribiendo)
            document.addEventListener('keydown', function(e) {
                const tag = document.activeElement && document.activeElement.tagName;
                if (e.key === 'm' && tag !== 'INPUT' && tag !== 'TEXTAREA') {
                    toggle.click();
                }
            });
        }

        function setupNavigation() {
            const links = document.querySelectorAll('.sidebar-link');
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    
                    // Actualizar enlace activo
                    links.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Actualizar t√≠tulo de secci√≥n
                    const sectionTitle = this.textContent.trim();
                    const currentEl = document.getElementById('currentSection');
                    if (currentEl) currentEl.textContent = sectionTitle;
                });
            });
        }

        function showSection(sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la secci√≥n seleccionada con animaci√≥n
            const activeSection = document.getElementById(sectionName + 'Section');
            if (activeSection) {
                activeSection.classList.add('active');
                // Agregar animaci√≥n de entrada
                activeSection.style.animation = 'fadeIn 0.3s ease';
            }
            
            // Actualizar t√≠tulo de la secci√≥n
            const sectionTitles = {
                'metrics': 'M√©tricas',
                'users': 'Gesti√≥n de Usuarios',
                'offers': 'Ofertas de Pr√°ctica',
                'applications': 'Postulaciones',
                
            };
            
            const title = sectionTitles[sectionName] || 'Panel de Administraci√≥n';
            document.getElementById('sectionTitle').textContent = title;
            
            // Actualizar breadcrumb (si existe en el DOM)
            const currentSectionEl = document.getElementById('currentSection');
            if (currentSectionEl) currentSectionEl.textContent = sectionTitles[sectionName] || sectionName;
            
            // Desplazarse al inicio de la p√°gina
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function loadMetrics() {
            // Mostrar esqueleto de carga
            const metrics = ['Users', 'Offers', 'Practices', 'Applications'];
            metrics.forEach(metric => {
                const element = document.getElementById(`metric${metric}`);
                if (element) {
                    element.innerHTML = '<div class="placeholder" style="height:48px; border-radius:8px; width:60%; margin:0 auto;"></div>';
                }
            });
            
            // Simular carga de m√©tricas
            setTimeout(() => {
                // Actualizar m√©tricas
                const mu = document.getElementById('metricUsers');
                const mo = document.getElementById('metricOffers');
                const mp = document.getElementById('metricPractices');
                const ma = document.getElementById('metricApplications');
                if (mu) mu.textContent = '245';
                if (mo) mo.textContent = '18';
                if (mp) mp.textContent = '76';
                if (ma) ma.textContent = '42';
            }, 800);
        }

        async function loadUsers() {
            try {
                const search = document.getElementById('userSearch').value;
                const role = document.getElementById('roleFilter').value;
                
                const users = await apiGetUsers({ search, role });
                renderUsers(users);
            } catch (error) {
                showNotification('Error al cargar usuarios', 'error');
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No se encontraron usuarios</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="badge badge-${user.role}">${getRoleLabel(user.role)}</span></td>
                    <td>${formatDate(user.date_joined)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editUser(${user.id})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadOffers() {
            try {
                const search = document.getElementById('offerSearch').value;
                const status = document.getElementById('offerStatusFilter').value;
                
                const offers = await apiGetOffers({ search, status });
                renderAdminOffers(offers);
            } catch (error) {
                showNotification('Error al cargar ofertas', 'error');
            }
        }

        function renderAdminOffers(offers) {
            const grid = document.getElementById('offersGrid');
            if (offers.length === 0) {
                grid.innerHTML = '<p class="empty-state">No se encontraron ofertas</p>';
                return;
            }
            
            grid.innerHTML = offers.map(offer => `
                <div class="offer-card">
                    <div class="offer-header">
                        <h3 class="offer-title">${offer.title}</h3>
                        <span class="badge badge-${offer.status}">${getStatusLabel(offer.status)}</span>
                    </div>
                    <div class="offer-company">${offer.company_name || 'Empresa'}</div>
                    <div class="offer-details">
                        <span>üìö ${offer.career}</span>
                        <span>üìÖ ${formatDate(offer.deadline)}</span>
                    </div>
                    <div class="offer-actions">
                        ${offer.status === 'pending' ? `
                            <button class="btn btn-sm btn-primary" onclick="approveOffer(${offer.id})">Aprobar</button>
                            <button class="btn btn-sm btn-danger" onclick="rejectOffer(${offer.id})">Rechazar</button>
                        ` : ''}
                        <button class="btn btn-sm btn-secondary" onclick="showOfferDetail(${offer.id})">Ver</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadApplications() {
            try {
                const status = document.getElementById('applicationStatusFilter').value;
                const applications = await apiGetAllApplications({ status });
                renderApplications(applications);
            } catch (error) {
                showNotification('Error al cargar postulaciones', 'error');
            }
        }

        function renderApplications(applications) {
            const tbody = document.getElementById('applicationsTableBody');
            if (applications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No se encontraron postulaciones</td></tr>';
                return;
            }
            
            tbody.innerHTML = applications.map(app => `
                <tr>
                    <td>${app.id}</td>
                    <td>${app.student_name}</td>
                    <td>${app.offer_title}</td>
                    <td>${app.company_name}</td>
                    <td><span class="badge badge-${app.status}">${getStatusLabel(app.status)}</span></td>
                    <td>${formatDate(app.applied_at)}</td>
                    <td>
                        ${app.status === 'company_accepted' ? `
                            <button class="btn btn-sm btn-primary" onclick="openAssignTeacher(${app.id})">Asignar Profesor</button>
                        ` : ''}
                        ${app.status === 'pending' || app.status === 'company_accepted' ? `
                            <button class="btn btn-sm btn-danger" onclick="rejectApplication(${app.id})">Rechazar</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        async function approveOffer(offerId) {
            if (!confirm('¬øAprobar esta oferta?')) return;
            try {
                await apiUpdateOffer(offerId, { status: 'approved' });
                showNotification('Oferta aprobada', 'success');
                loadOffers();
            } catch (error) {
                showNotification('Error al aprobar oferta', 'error');
            }
        }

        async function rejectOffer(offerId) {
            if (!confirm('¬øRechazar esta oferta?')) return;
            try {
                await apiUpdateOffer(offerId, { status: 'rejected' });
                showNotification('Oferta rechazada', 'success');
                loadOffers();
            } catch (error) {
                showNotification('Error al rechazar oferta', 'error');
            }
        }

        async function rejectApplication(appId) {
            if (!confirm('¬øRechazar esta postulaci√≥n?')) return;
            try {
                await apiAdminReviewApplication(appId, { status: 'rejected' });
                showNotification('Postulaci√≥n rechazada', 'success');
                loadApplications();
            } catch (error) {
                showNotification('Error al rechazar postulaci√≥n', 'error');
            }
        }

        async function openAssignTeacher(appId) {
            try {
                const teachers = await apiGetUsers({ role: 'teacher' });
                const select = document.getElementById('teacherSelect');
                select.innerHTML = '<option value="">Selecciona un profesor</option>' + 
                    teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

                document.getElementById('applicationId').value = appId;

                // Reset UI state
                const confirmBtn = document.getElementById('confirmAssignTeacher');
                const confirmText = document.getElementById('confirmAssignText');
                const spinner = document.getElementById('confirmAssignSpinner');
                const teacherError = document.getElementById('teacherError');

                if (confirmBtn) {
                    confirmBtn.disabled = true;
                }
                if (confirmText) confirmText.textContent = 'Asignar';
                if (spinner) spinner.classList.add('hidden');
                if (teacherError) teacherError.classList.add('hidden');
                // Reset additional form fields
                const assignedDate = document.getElementById('assignedDate');
                const assignedNotes = document.getElementById('assignedNotes');
                const notifyStudent = document.getElementById('notifyStudent');
                if (assignedDate) assignedDate.value = '';
                if (assignedNotes) assignedNotes.value = '';
                if (notifyStudent) notifyStudent.checked = false;

                // Enable confirm only when a teacher is selected
                select.onchange = function() {
                    if (teacherError) teacherError.classList.add('hidden');
                    if (confirmBtn) confirmBtn.disabled = !this.value;
                };

                openModal('assignTeacherModal');
                // Focus select for faster keyboard flow
                setTimeout(() => select.focus(), 120);
            } catch (error) {
                showNotification('Error al cargar profesores', 'error');
            }
        }

        async function handleAssignTeacher(e) {
            if (e && e.preventDefault) e.preventDefault();
            const appId = document.getElementById('applicationId').value;
            const select = document.getElementById('teacherSelect');
            const teacherId = select ? select.value : '';
            const teacherError = document.getElementById('teacherError');
            const confirmBtn = document.getElementById('confirmAssignTeacher');
            const confirmText = document.getElementById('confirmAssignText');
            const spinner = document.getElementById('confirmAssignSpinner');

            if (!teacherId) {
                if (teacherError) {
                    teacherError.textContent = 'Por favor selecciona un profesor.';
                    teacherError.classList.remove('hidden');
                }
                if (select) select.focus();
                return;
            }

            const assignedDateEl = document.getElementById('assignedDate');
            const assignedNotesEl = document.getElementById('assignedNotes');
            const notifyEl = document.getElementById('notifyStudent');

            const assignedDateVal = assignedDateEl ? assignedDateEl.value : '';
            const assignedNotesVal = assignedNotesEl ? assignedNotesEl.value.trim() : '';
            const notifyVal = notifyEl ? !!notifyEl.checked : false;

            try {
                // UI: show loading
                if (confirmBtn) confirmBtn.disabled = true;
                if (confirmText) confirmText.textContent = 'Asignando...';
                if (spinner) spinner.classList.remove('hidden');

                await apiAdminReviewApplication(appId, {
                    status: 'approved',
                    assigned_teacher_id: teacherId,
                    assigned_date: assignedDateVal || null,
                    admin_notes: assignedNotesVal || null,
                    notify_student: notifyVal
                });

                showNotification('Profesor asignado exitosamente', 'success');
                closeModal('assignTeacherModal');
                loadApplications();
            } catch (error) {
                showNotification('Error al asignar profesor', 'error');
            } finally {
                // Reset button text and hide spinner; keep disabled until new selection when reopened
                if (confirmText) confirmText.textContent = 'Asignar';
                if (spinner) spinner.classList.add('hidden');
                if (confirmBtn) confirmBtn.disabled = true;
            }
        }

        function editUser(userId) {
            showNotification('Funcionalidad de edici√≥n en desarrollo', 'info');
        }

        async function deleteUser(userId) {
            if (!confirm('¬øEliminar este usuario?')) return;
            try {
                await apiDeleteUser(userId);
                showNotification('Usuario eliminado', 'success');
                loadUsers();
            } catch (error) {
                showNotification('Error al eliminar usuario', 'error');
            }
        }

        function getRoleLabel(role) {
            const labels = {
                'admin': 'Administrador',
                'student': 'Estudiante',
                'company': 'Empresa',
                'teacher': 'Profesor'
            };
            return labels[role] || role;
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pendiente',
                'approved': 'Aprobada',
                'rejected': 'Rechazada',
                'company_accepted': 'Empresa Acept√≥',
                'company_rejected': 'Empresa Rechaz√≥'
            };
            return labels[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO');
        }
    </script>
</body>
</html>