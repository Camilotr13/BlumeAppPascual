<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Estudiante - Sistema de Pr√°cticas</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="assets/logo.svg" alt="Logo" class="sidebar-logo">
                <span class="sidebar-title">Estudiante</span>
            </div>
            <nav class="sidebar-nav">
                <a href="#profile" class="sidebar-link active" data-section="profile">
                    <span class="sidebar-icon">üë§</span>
                    <span>Mi Perfil</span>
                </a>
                <a href="#offers" class="sidebar-link" data-section="offers">
                    <span class="sidebar-icon">üîç</span>
                    <span>Buscar Ofertas</span>
                </a>
                <a href="#myapplications" class="sidebar-link" data-section="myapplications">
                    <span class="sidebar-icon">üìù</span>
                    <span>Mis Postulaciones</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn btn-text btn-block">Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <main class="dashboard-main">
            <header class="dashboard-header">
                <h1 id="sectionTitle">Mi Perfil</h1>
                <div class="user-info">
                    <span id="userName">Estudiante</span>
                    <span class="user-role">Estudiante</span>
                </div>
            </header>

            <!-- Perfil Section -->
            <section id="profileSection" class="dashboard-section active p-4 sm:p-6">
                <!-- Enhanced Profile Header -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden mb-8 border border-gray-100 dark:border-gray-700 transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1 profile-card">
                    <div class="h-48 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 animate-gradient-x"></div>
                    <div class="px-8 pb-8 -mt-16 relative profile-body">
                        <div class="flex flex-col md:flex-row items-start md:items-end justify-between">
                            <div class="flex flex-col sm:flex-row items-start sm:items-end space-y-4 sm:space-y-0 sm:space-x-8 w-full">
                                <div class="relative group profile-avatar-wrap">
                                    <div class="w-36 h-36 rounded-full border-4 border-white dark:border-gray-800 bg-white dark:bg-gray-700 flex items-center justify-center text-6xl text-gray-400 overflow-hidden shadow-xl transform transition-all duration-300 group-hover:scale-105" id="profileAvatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <button class="absolute bottom-0 right-0 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full shadow-lg transform transition-all duration-300 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 profile-avatar-edit">
                                        <i class="fas fa-camera text-sm"></i>
                                    </button>
                                </div>
                                <div class="flex-1 mt-4 sm:mt-0 profile-main">
                                    <div class="flex flex-col sm:flex-row sm:items-end justify-between w-full">
                                        <div class="profile-meta">
                                            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-1" id="profileName">Estudiante</h2>
                                            <p class="text-gray-600 dark:text-gray-300 text-base sm:text-lg mb-3" id="profileEmail">
                                                <i class="fas fa-envelope text-blue-500 mr-2"></i><span id="profileEmailValue">estudiante@pascualbravo.edu.co</span>
                                            </p>
                                            <div class="flex flex-wrap gap-2 profile-badges">
                                                <span class="px-4 py-1.5 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200">
                                                    <i class="fas fa-graduation-cap mr-2"></i>
                                                    <span id="profileCareer">Ingenier√≠a de Sistemas</span>
                                                </span>
                                                <span class="px-4 py-1.5 rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-200">
                                                    <i class="fas fa-circle text-[8px] mr-2 animate-pulse"></i>
                                                    <span>Activo</span>
                                                </span>
                                                <span class="px-4 py-1.5 rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-200">
                                                    <i class="fas fa-star text-yellow-400 mr-2"></i>
                                                    <span>4.8/5.0</span>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="mt-4 sm:mt-0 flex space-x-3 profile-actions">
                                            <button class="btn btn-primary group flex items-center px-5 py-2.5 text-sm font-medium" onclick="editProfile()">
                                                <i class="fas fa-edit mr-2 group-hover:animate-pulse"></i>Editar Perfil
                                            </button>
                                            <button class="btn btn-outline-secondary group flex items-center px-5 py-2.5 text-sm font-medium">
                                                <i class="fas fa-share-alt mr-2"></i>Compartir
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metrics removed as requested -->

                <!-- Simplified Profile Cards: Personal / Identificaci√≥n / Acad√©mico -->
                <div class="profile-cards-row">
                    <!-- Personal -->
                    <div class="card">
                        <h3 class="card-title">Personal</h3>
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm text-gray-500">Nombre</p>
                                <p class="text-lg font-semibold" id="profileName">Estudiante</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Correo</p>
                                <p class="text-lg font-semibold text-blue-600" id="profileEmail2">-</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Tel√©fono</p>
                                <p class="text-lg font-semibold" id="profilePhone">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Identificaci√≥n -->
                    <div class="card">
                        <h3 class="card-title">Identificaci√≥n</h3>
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm text-gray-500">Documento</p>
                                <p class="text-lg font-semibold" id="profileDocument">-</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Miembro desde</p>
                                <p class="text-lg font-semibold" id="profileJoinDate">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Acad√©mico -->
                    <div class="card">
                        <h3 class="card-title">Acad√©mico</h3>
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm text-gray-500">Programa / Carrera</p>
                                <p class="text-lg font-semibold" id="profileCareer">-</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Instituci√≥n</p>
                                <p class="text-lg font-semibold" id="profileInstitution">Instituci√≥n Universitaria Pascual Bravo</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Academic Tab Content -->
                <!-- Academic history removed as requested -->

                <!-- Skills section removed as requested -->

            </section>

            <!-- Ofertas Section -->
            <section id="offersSection" class="dashboard-section">
                <!-- ... -->
                <div class="offers-header">
                    <h2 class="card-title" style="margin:0;">üîç Buscar Ofertas</h2>
                    <div class="offers-filters">
                        <div class="search-wrapper">
                            <input type="text" id="offerSearch" class="search-input modern" placeholder="Buscar ofertas...">
                        </div>
                        <div class="filter-wrapper">
                            <select id="careerFilter" class="filter-select">
                                <option value="">Todas las carreras</option>
                                <option value="Ingenier√≠a de Sistemas">Ingenier√≠a de Sistemas</option>
                                <option value="Ingenier√≠a Industrial">Ingenier√≠a Industrial</option>
                                <option value="Tecnolog√≠a en Desarrollo de Software">Tecnolog√≠a en Desarrollo de Software</option>
                                <option value="Tecnolog√≠a en Gesti√≥n Administrativa">Tecnolog√≠a en Gesti√≥n Administrativa</option>
                            </select>
                        </div>
                        <div class="filter-wrapper">
                            <select id="typeFilter" class="filter-select">
                                <option value="">Todos los tipos</option>
                                <option value="Pasant√≠a">Pasant√≠a</option>
                                <option value="Pr√°ctica">Pr√°ctica</option>
                                <option value="Proyecto">Proyecto</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="offersGrid" class="offers-grid">
                    <!-- Se carga din√°micamente -->
                </div>
            </section>

            <!-- Mis Postulaciones Section -->
            <section id="myapplicationsSection" class="dashboard-section">
                <div class="applications-header">
                    <h2 class="card-title" style="margin:0;">üìù Mis Postulaciones</h2>
                    <div class="filter-wrapper">
                        <select id="applicationStatusFilter" class="filter-select">
                            <option value="">Todos los estados</option>
                            <option value="pending">Pendientes</option>
                            <option value="company_accepted">Empresa Acept√≥</option>
                            <option value="company_rejected">Empresa Rechaz√≥</option>
                            <option value="approved">Aprobadas</option>
                            <option value="rejected">Rechazadas</option>
                        </select>
                    </div>
                </div>

                <div id="applicationsContainer" class="applications-grid">
                    <!-- Se carga din√°micamente -->
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Detalle de Oferta -->
    <div id="offerModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div id="offerDetailContent">
                <!-- Se carga din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="edit-profile-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <div class="absolute top-0 right-0 pt-4 pr-4">
                    <button type="button" class="bg-white dark:bg-gray-800 rounded-md text-gray-400 hover:text-gray-500 focus:outline-none modal-close" id="closeEditProfileModal">
                        <span class="sr-only">Cerrar</span>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div>
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900">
                        <i class="fas fa-user-edit text-blue-600 dark:text-blue-300"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-5">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="edit-profile-title">Editar Perfil</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Actualiza tu informaci√≥n personal. Los campos con * son obligatorios.</p>
                        </div>
                    </div>
                </div>
                <form id="editProfileForm" class="mt-4 space-y-4" onsubmit="return false;">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label for="editName" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Nombre *</label>
                            <input id="editName" type="text" required class="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        </div>
                        <div>
                            <label for="editEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Correo *</label>
                            <input id="editEmail" type="email" required class="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        </div>
                        <div>
                            <label for="editPhone" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Tel√©fono</label>
                            <input id="editPhone" type="text" class="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        </div>
                        <div>
                            <label for="editDocument" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Documento</label>
                            <input id="editDocument" type="text" class="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        </div>
                    </div>
                    <div>
                        <label for="editAddress" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Direcci√≥n</label>
                        <input id="editAddress" type="text" class="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                    </div>
                    <div>
                        <label for="editCareer" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Carrera / Programa</label>
                        <input id="editCareer" type="text" class="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                    </div>
                    <div class="flex items-center justify-end gap-3 pt-2">
                        <button type="button" id="cancelEditProfile" class="btn btn-secondary">Cancelar</button>
                        <button type="button" id="saveEditProfile" class="btn btn-primary">Guardar cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="notification"></div>

    <script src="js/mockData.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/offers.js"></script>
    <script src="js/applications.js"></script>

    <script>
        let currentUser;

        document.addEventListener('DOMContentLoaded', () => {
            initializeMockData();
            requireAuth('student');
            
            currentUser = getCurrentUser();
            if (!currentUser) {
                showNotification('No se encontr√≥ usuario. Vuelve a iniciar sesi√≥n.', 'error');
                setTimeout(() => logout(), 800);
                return;
            }
            document.getElementById('userName').textContent = currentUser.name;
            
            setupNavigation();
            loadProfile();
            
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('offerSearch').addEventListener('input', loadOffers);
            document.getElementById('careerFilter').addEventListener('change', loadOffers);
            document.getElementById('typeFilter').addEventListener('change', loadOffers);
            document.getElementById('applicationStatusFilter').addEventListener('change', loadMyApplications);
            // Edit profile modal handlers
            const editBtn = document.querySelector('[onclick="editProfile()"]');
            if (editBtn) editBtn.addEventListener('click', openEditProfileModal);

            const cancelEdit = document.getElementById('cancelEditProfile');
            if (cancelEdit) cancelEdit.addEventListener('click', () => closeModal('editProfileModal'));

            const closeEdit = document.getElementById('closeEditProfileModal');
            if (closeEdit) closeEdit.addEventListener('click', () => closeModal('editProfileModal'));

            const saveEdit = document.getElementById('saveEditProfile');
            if (saveEdit) saveEdit.addEventListener('click', handleEditProfileSubmit);
        });

        function setupNavigation() {
            const links = document.querySelectorAll('.sidebar-link');
            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    showSection(section);
                    
                    links.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });
        }

        function showSection(sectionName) {
            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach(s => s.classList.remove('active'));
            
            const section = document.getElementById(sectionName + 'Section');
            if (section) {
                section.classList.add('active');
                
                const titles = {
                    'profile': 'Mi Perfil',
                    'offers': 'Buscar Ofertas',
                    'myapplications': 'Mis Postulaciones'
                };
                document.getElementById('sectionTitle').textContent = titles[sectionName];
                
                if (sectionName === 'profile') loadProfile();
                if (sectionName === 'offers') loadOffers();
                if (sectionName === 'myapplications') loadMyApplications();
            }
        }

        async function loadProfile() {
            try {
                document.getElementById('profileName').textContent = currentUser.name;
                const emailEl = document.getElementById('profileEmailValue');
                if (emailEl) emailEl.textContent = currentUser.email;
                const email2El = document.getElementById('profileEmail2');
                if (email2El) email2El.textContent = currentUser.email;
                document.getElementById('profileCareer').textContent = 'üìö ' + (currentUser.career || 'No especificado');
                document.getElementById('profileDocument').textContent = currentUser.student_id || '-';
                document.getElementById('profilePhone').textContent = currentUser.phone || '-';
                document.getElementById('profileJoinDate').textContent = formatDate(currentUser.date_joined);
                // optional fields
                const instEl = document.getElementById('profileInstitution');
                if (instEl) instEl.textContent = instEl.textContent || 'Instituci√≥n Universitaria Pascual Bravo';
                const programEl = document.getElementById('profileProgram');
                if (programEl) programEl.textContent = currentUser.program || currentUser.career || '-';
                
                // Cargar estad√≠sticas
                const applications = await apiGetStudentApplications(currentUser.id);
                document.getElementById('statApplications').textContent = applications.length;
                // statAccepted existe en el HTML (nombre de id corregido)
                const statAcceptedEl = document.getElementById('statAccepted');
                if (statAcceptedEl) statAcceptedEl.textContent = applications.filter(a => a.status === 'approved').length;
                const statPendingEl = document.getElementById('statPending');
                if (statPendingEl) statPendingEl.textContent = applications.filter(a => a.status === 'pending').length;
                const statRejectedEl = document.getElementById('statRejected');
                if (statRejectedEl) statRejectedEl.textContent = applications.filter(a => a.status === 'rejected' || a.status === 'company_rejected').length;
                
            } catch (error) {
                showNotification('Error al cargar perfil', 'error');
            }
        }

        async function loadOffers() {
            try {
                const search = document.getElementById('offerSearch').value;
                const career = document.getElementById('careerFilter').value;
                const type = document.getElementById('typeFilter').value;
                
                const offers = await apiGetOffers({ search, career, type, status: 'approved' });
                renderOffers(offers);
            } catch (error) {
                showNotification('Error al cargar ofertas', 'error');
            }
        }

        function renderOffers(offers) {
            const grid = document.getElementById('offersGrid');
            if (offers.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: var(--gray-600);"><p style="font-size: var(--font-size-lg); margin: 0;">üì≠ No se encontraron ofertas disponibles</p></div>';
                return;
            }
            
            grid.innerHTML = offers.map(offer => `
                <div class="offer-card" data-offer-id="${offer.id}">
                    <div class="offer-card-header">
                        <div>
                            <h3 class="offer-card-title">${offer.title}</h3>
                            <p class="offer-card-company">${offer.company_name || 'Empresa'}</p>
                        </div>
                        <span class="badge badge-${offer.type}" style="background: var(--secondary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700;">${offer.type}</span>
                    </div>
                    <div class="offer-card-meta">
                        <div class="meta-item">
                            <strong>Carrera</strong>
                            üìö ${offer.career}
                        </div>
                        <div class="meta-item">
                            <strong>Plazo</strong>
                            üìÖ ${formatDate(offer.deadline)}
                        </div>
                    </div>
                    <div class="offer-card-description">${truncate(offer.description, 120)}</div>
                    <div class="offer-card-footer">
                        <span class="offer-card-deadline">‚è∞ Vence: ${formatDate(offer.deadline)}</span>
                        <button class="apply-button" onclick="applyToOffer(${offer.id})">Aplicar</button>
                    </div>
                </div>
            `).join('');
        }

        async function applyToOffer(offerId) {
            if (!confirm('¬øDeseas aplicar a esta oferta?')) return;
            
            try {
                // Verificar si ya aplic√≥
                const myApps = await apiGetStudentApplications(currentUser.id);
                const alreadyApplied = myApps.some(app => app.offer_id === offerId);
                
                if (alreadyApplied) {
                    showNotification('Ya has aplicado a esta oferta', 'warning');
                    return;
                }
                
                const profileSnapshot = {
                    name: currentUser.name,
                    email: currentUser.email,
                    phone: currentUser.phone,
                    career: currentUser.career,
                    student_id: currentUser.student_id
                };
                
                await apiApplyToOffer(offerId, {
                    student_id: currentUser.id,
                    profile_snapshot: profileSnapshot
                });
                
                showNotification('¬°Aplicaci√≥n enviada exitosamente!', 'success');
                
            } catch (error) {
                showNotification(error.message || 'Error al aplicar a la oferta', 'error');
            }
        }

        async function showOfferDetail(offerId) {
            try {
                const offer = await apiGetOffer(offerId);
                renderOfferModal(offer);
                openModal('offerModal');
            } catch (error) {
                showNotification('Error al cargar oferta', 'error');
            }
        }

        function renderOfferModal(offer) {
            const content = document.getElementById('offerDetailContent');
            content.innerHTML = `
                <h2 class="modal-title">${offer.title}</h2>
                <div class="offer-detail">
                    <p><strong>Empresa:</strong> ${offer.company_name || 'No especificado'}</p>
                    <p><strong>Tipo:</strong> <span class="badge badge-${offer.type}">${offer.type}</span></p>
                    <p><strong>Carrera:</strong> ${offer.career}</p>
                    <p><strong>Fecha L√≠mite:</strong> ${formatDate(offer.deadline)}</p>
                    
                    <h3>Descripci√≥n</h3>
                    <p>${offer.description}</p>
                    
                    <h3>Requisitos</h3>
                    <p>${offer.requirements}</p>
                    
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="applyToOffer(${offer.id}); closeModal('offerModal')">Aplicar Ahora</button>
                        <button class="btn btn-secondary" onclick="closeModal('offerModal')">Cerrar</button>
                    </div>
                </div>
            `;
        }

        async function loadMyApplications() {
            try {
                const status = document.getElementById('applicationStatusFilter').value;
                let applications = await apiGetStudentApplications(currentUser.id);
                
                if (status) {
                    applications = applications.filter(app => app.status === status);
                }
                
                renderMyApplications(applications);
            } catch (error) {
                showNotification('Error al cargar postulaciones', 'error');
            }
        }

        function renderMyApplications(applications) {
            const container = document.getElementById('applicationsContainer');
            if (applications.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: var(--gray-600);"><p style="font-size: var(--font-size-lg); margin: 0;">üì≠ No tienes postulaciones a√∫n</p></div>';
                return;
            }
            
            container.innerHTML = applications.map(app => `
                <div class="application-card">
                    <div class="application-header">
                        <div>
                            <h3 class="application-title">${app.offer_title}</h3>
                            <p style="margin: 4px 0 0 0; font-size: var(--font-size-sm); color: var(--gray-600);">${app.company_name}</p>
                        </div>
                        <span class="application-status status-${app.status}">${getStatusLabel(app.status)}</span>
                    </div>
                    <div class="application-info">
                        <div class="info-row">
                            <strong>üìÖ Aplicado:</strong>
                            <span class="value">${formatDate(app.applied_at)}</span>
                        </div>
                        ${app.assigned_teacher_name ? `
                            <div class="info-row">
                                <strong>üë®‚Äçüè´ Profesor:</strong>
                                <span class="value">${app.assigned_teacher_name}</span>
                            </div>
                        ` : ''}
                        <div class="info-row">
                            <strong>üìå Estado:</strong>
                            <span class="value">${getStatusMessage(app.status)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pendiente',
                'company_accepted': 'Empresa Acept√≥',
                'company_rejected': 'Empresa Rechaz√≥',
                'approved': 'Aprobada',
                'rejected': 'Rechazada'
            };
            return labels[status] || status;
        }

        function getStatusMessage(status) {
            const messages = {
                'pending': '‚è≥ Tu postulaci√≥n est√° siendo revisada por la empresa',
                'company_accepted': '‚úÖ La empresa te acept√≥. Pendiente de aprobaci√≥n del admin y asignaci√≥n de profesor',
                'company_rejected': '‚ùå La empresa rechaz√≥ tu postulaci√≥n',
                'approved': 'üéâ ¬°Felicitaciones! Tu pr√°ctica fue aprobada y tienes un profesor asignado',
                'rejected': '‚ùå Tu postulaci√≥n fue rechazada por el administrador'
            };
            return `<p class="status-message">${messages[status] || ''}</p>`;
        }

        function openEditProfileModal() {
            // populate form with current user data
            const name = document.getElementById('editName');
            const email = document.getElementById('editEmail');
            const phone = document.getElementById('editPhone');
            const documentEl = document.getElementById('editDocument');
            const address = document.getElementById('editAddress');
            const career = document.getElementById('editCareer');

            if (name) name.value = currentUser.name || '';
            if (email) email.value = currentUser.email || '';
            if (phone) phone.value = currentUser.phone || '';
            if (documentEl) documentEl.value = currentUser.student_id || '';
            if (address) address.value = currentUser.address || '';
            if (career) career.value = currentUser.career || '';

            openModal('editProfileModal');
            setTimeout(() => { if (name) name.focus(); }, 120);
        }

        async function handleEditProfileSubmit(e) {
            // gather values
            const name = document.getElementById('editName').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const doc = document.getElementById('editDocument').value.trim();
            const address = document.getElementById('editAddress').value.trim();
            const career = document.getElementById('editCareer').value.trim();

            if (!name || !email) {
                showNotification('Nombre y correo son obligatorios', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveEditProfile');
            const originalText = saveBtn ? saveBtn.textContent : null;
            if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Guardando...'; }

            try {
                const payload = {
                    name,
                    email,
                    phone,
                    student_id: doc || null,
                    address: address || null,
                    career: career || null
                };

                const updated = await apiUpdateUser(currentUser.id, payload);
                // update local currentUser
                currentUser = Object.assign({}, currentUser, updated);
                // refresh UI
                loadProfile();
                showNotification('Perfil actualizado correctamente', 'success');
                closeModal('editProfileModal');
            } catch (err) {
                showNotification(err.message || 'Error al actualizar perfil', 'error');
            } finally {
                if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = originalText || 'Guardar cambios'; }
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO');
        }

        function truncate(text, length) {
            if (!text) return '';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }
    </script>
</body>
</html>