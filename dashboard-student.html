<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Estudiante - Sistema de Pr√°cticas</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="assets/logo.svg" alt="Logo" class="sidebar-logo">
                <span class="sidebar-title">Estudiante</span>
            </div>
            <nav class="sidebar-nav">
                <a href="#profile" class="sidebar-link active" data-section="profile">
                    <span class="sidebar-icon">üë§</span>
                    <span>Mi Perfil</span>
                </a>
                <a href="#offers" class="sidebar-link" data-section="offers">
                    <span class="sidebar-icon">üîç</span>
                    <span>Buscar Ofertas</span>
                </a>
                <a href="#myapplications" class="sidebar-link" data-section="myapplications">
                    <span class="sidebar-icon">üìù</span>
                    <span>Mis Postulaciones</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn btn-text btn-block">Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <main class="dashboard-main">
            <header class="dashboard-header">
                <h1 id="sectionTitle">Mi Perfil</h1>
                <div class="user-info">
                    <span id="userName">Estudiante</span>
                    <span class="user-role">Estudiante</span>
                </div>
            </header>

            <!-- Perfil Section -->
            <section id="profileSection" class="dashboard-section active">
                <!-- Profile Header Card -->
                <div class="profile-header-card">
                    <div class="profile-header-background"></div>
                    <div class="profile-header-content">
                        <div class="profile-avatar-large">
                            <div class="avatar-circle" id="profileAvatar">üë§</div>
                        </div>
                        <div class="profile-header-info">
                            <h2 class="profile-name" id="profileName">Estudiante</h2>
                            <p class="profile-email" id="profileEmail">estudiante@pascualbravo.edu.co</p>
                            <p class="profile-career" id="profileCareer">üìö Carrera</p>
                        </div>
                        <button class="edit-profile-btn" onclick="editProfile()">‚úèÔ∏è Editar</button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="student-stats-grid">
                    <div class="stat-card stat-card-total">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-content">
                            <div class="stat-value" id="statApplications">0</div>
                            <div class="stat-label">Postulaciones</div>
                        </div>
                    </div>
                    <div class="stat-card stat-card-approved">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <div class="stat-value" id="statApproved">0</div>
                            <div class="stat-label">Aprobadas</div>
                        </div>
                    </div>
                    <div class="stat-card stat-card-pending">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-content">
                            <div class="stat-value" id="statPending">0</div>
                            <div class="stat-label">Pendientes</div>
                        </div>
                    </div>
                    <div class="stat-card stat-card-rejected">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-content">
                            <div class="stat-value" id="statRejected">0</div>
                            <div class="stat-label">Rechazadas</div>
                        </div>
                    </div>
                </div>

                <!-- Profile Details Grid -->
                <div class="profile-details-grid">
                    <div class="detail-card">
                        <div class="detail-header">
                            <span class="detail-icon">üÜî</span>
                            <h3>Identificaci√≥n</h3>
                        </div>
                        <div class="detail-content">
                            <div class="detail-item">
                                <label>Documento:</label>
                                <span id="profileDocument">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Miembro desde:</label>
                                <span id="profileJoinDate">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-header">
                            <span class="detail-icon">üìû</span>
                            <h3>Contacto</h3>
                        </div>
                        <div class="detail-content">
                            <div class="detail-item">
                                <label>Tel√©fono:</label>
                                <span id="profilePhone">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Email:</label>
                                <span id="profileEmail2" style="word-break: break-all;">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-header">
                            <span class="detail-icon">üéì</span>
                            <h3>Acad√©mico</h3>
                        </div>
                        <div class="detail-content">
                            <div class="detail-item">
                                <label>Carrera:</label>
                                <span id="profileCareer2">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Estado:</label>
                                <span class="badge" style="background: var(--secondary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">Activo</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ofertas Section -->
            <section id="offersSection" class="dashboard-section">
                <div class="offers-header">
                    <h2 class="card-title" style="margin:0;">üîç Buscar Ofertas</h2>
                    <div class="offers-filters">
                        <div class="search-wrapper">
                            <input type="text" id="offerSearch" class="search-input modern" placeholder="Buscar ofertas...">
                        </div>
                        <div class="filter-wrapper">
                            <select id="careerFilter" class="filter-select">
                                <option value="">Todas las carreras</option>
                                <option value="Ingenier√≠a de Sistemas">Ingenier√≠a de Sistemas</option>
                                <option value="Ingenier√≠a Industrial">Ingenier√≠a Industrial</option>
                                <option value="Tecnolog√≠a en Desarrollo de Software">Tecnolog√≠a en Desarrollo de Software</option>
                                <option value="Tecnolog√≠a en Gesti√≥n Administrativa">Tecnolog√≠a en Gesti√≥n Administrativa</option>
                            </select>
                        </div>
                        <div class="filter-wrapper">
                            <select id="typeFilter" class="filter-select">
                                <option value="">Todos los tipos</option>
                                <option value="Pasant√≠a">Pasant√≠a</option>
                                <option value="Pr√°ctica">Pr√°ctica</option>
                                <option value="Proyecto">Proyecto</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="offersGrid" class="offers-grid">
                    <!-- Se carga din√°micamente -->
                </div>
            </section>

            <!-- Mis Postulaciones Section -->
            <section id="myapplicationsSection" class="dashboard-section">
                <div class="applications-header">
                    <h2 class="card-title" style="margin:0;">üìù Mis Postulaciones</h2>
                    <div class="filter-wrapper">
                        <select id="applicationStatusFilter" class="filter-select">
                            <option value="">Todos los estados</option>
                            <option value="pending">Pendientes</option>
                            <option value="company_accepted">Empresa Acept√≥</option>
                            <option value="company_rejected">Empresa Rechaz√≥</option>
                            <option value="approved">Aprobadas</option>
                            <option value="rejected">Rechazadas</option>
                        </select>
                    </div>
                </div>

                <div id="applicationsContainer" class="applications-grid">
                    <!-- Se carga din√°micamente -->
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Detalle de Oferta -->
    <div id="offerModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div id="offerDetailContent">
                <!-- Se carga din√°micamente -->
            </div>
        </div>
    </div>

    <div id="notification"></div>

    <script src="js/mockData.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/offers.js"></script>
    <script src="js/applications.js"></script>
    <script src="js/profile.js"></script>
    <script>
        let currentUser;

        document.addEventListener('DOMContentLoaded', () => {
            initializeMockData();
            requireAuth('student');
            
            currentUser = getCurrentUser();
            document.getElementById('userName').textContent = currentUser.name;
            
            setupNavigation();
            loadProfile();
            
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('offerSearch').addEventListener('input', loadOffers);
            document.getElementById('careerFilter').addEventListener('change', loadOffers);
            document.getElementById('typeFilter').addEventListener('change', loadOffers);
            document.getElementById('applicationStatusFilter').addEventListener('change', loadMyApplications);
        });

        function setupNavigation() {
            const links = document.querySelectorAll('.sidebar-link');
            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    showSection(section);
                    
                    links.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });
        }

        function showSection(sectionName) {
            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach(s => s.classList.remove('active'));
            
            const section = document.getElementById(sectionName + 'Section');
            if (section) {
                section.classList.add('active');
                
                const titles = {
                    'profile': 'Mi Perfil',
                    'offers': 'Buscar Ofertas',
                    'myapplications': 'Mis Postulaciones'
                };
                document.getElementById('sectionTitle').textContent = titles[sectionName];
                
                if (sectionName === 'profile') loadProfile();
                if (sectionName === 'offers') loadOffers();
                if (sectionName === 'myapplications') loadMyApplications();
            }
        }

        async function loadProfile() {
            try {
                document.getElementById('profileName').textContent = currentUser.name;
                document.getElementById('profileEmail').textContent = currentUser.email;
                document.getElementById('profileEmail2').textContent = currentUser.email;
                document.getElementById('profileCareer').textContent = 'üìö ' + (currentUser.career || 'No especificado');
                document.getElementById('profileCareer2').textContent = currentUser.career || 'No especificado';
                document.getElementById('profileDocument').textContent = currentUser.student_id || '-';
                document.getElementById('profilePhone').textContent = currentUser.phone || '-';
                document.getElementById('profileJoinDate').textContent = formatDate(currentUser.date_joined);
                
                // Cargar estad√≠sticas
                const applications = await apiGetStudentApplications(currentUser.id);
                document.getElementById('statApplications').textContent = applications.length;
                document.getElementById('statApproved').textContent = applications.filter(a => a.status === 'approved').length;
                document.getElementById('statPending').textContent = applications.filter(a => a.status === 'pending').length;
                document.getElementById('statRejected').textContent = applications.filter(a => a.status === 'rejected' || a.status === 'company_rejected').length;
                
            } catch (error) {
                showNotification('Error al cargar perfil', 'error');
            }
        }

        async function loadOffers() {
            try {
                const search = document.getElementById('offerSearch').value;
                const career = document.getElementById('careerFilter').value;
                const type = document.getElementById('typeFilter').value;
                
                const offers = await apiGetOffers({ search, career, type, status: 'approved' });
                renderOffers(offers);
            } catch (error) {
                showNotification('Error al cargar ofertas', 'error');
            }
        }

        function renderOffers(offers) {
            const grid = document.getElementById('offersGrid');
            if (offers.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: var(--gray-600);"><p style="font-size: var(--font-size-lg); margin: 0;">üì≠ No se encontraron ofertas disponibles</p></div>';
                return;
            }
            
            grid.innerHTML = offers.map(offer => `
                <div class="offer-card" data-offer-id="${offer.id}">
                    <div class="offer-card-header">
                        <div>
                            <h3 class="offer-card-title">${offer.title}</h3>
                            <p class="offer-card-company">${offer.company_name || 'Empresa'}</p>
                        </div>
                        <span class="badge badge-${offer.type}" style="background: var(--secondary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700;">${offer.type}</span>
                    </div>
                    <div class="offer-card-meta">
                        <div class="meta-item">
                            <strong>Carrera</strong>
                            üìö ${offer.career}
                        </div>
                        <div class="meta-item">
                            <strong>Plazo</strong>
                            üìÖ ${formatDate(offer.deadline)}
                        </div>
                    </div>
                    <div class="offer-card-description">${truncate(offer.description, 120)}</div>
                    <div class="offer-card-footer">
                        <span class="offer-card-deadline">‚è∞ Vence: ${formatDate(offer.deadline)}</span>
                        <button class="apply-button" onclick="applyToOffer(${offer.id})">Aplicar</button>
                    </div>
                </div>
            `).join('');
        }

        async function applyToOffer(offerId) {
            if (!confirm('¬øDeseas aplicar a esta oferta?')) return;
            
            try {
                // Verificar si ya aplic√≥
                const myApps = await apiGetStudentApplications(currentUser.id);
                const alreadyApplied = myApps.some(app => app.offer_id === offerId);
                
                if (alreadyApplied) {
                    showNotification('Ya has aplicado a esta oferta', 'warning');
                    return;
                }
                
                const profileSnapshot = {
                    name: currentUser.name,
                    email: currentUser.email,
                    phone: currentUser.phone,
                    career: currentUser.career,
                    student_id: currentUser.student_id
                };
                
                await apiApplyToOffer(offerId, {
                    student_id: currentUser.id,
                    profile_snapshot: profileSnapshot
                });
                
                showNotification('¬°Aplicaci√≥n enviada exitosamente!', 'success');
                
            } catch (error) {
                showNotification(error.message || 'Error al aplicar a la oferta', 'error');
            }
        }

        async function showOfferDetail(offerId) {
            try {
                const offer = await apiGetOffer(offerId);
                renderOfferModal(offer);
                openModal('offerModal');
            } catch (error) {
                showNotification('Error al cargar oferta', 'error');
            }
        }

        function renderOfferModal(offer) {
            const content = document.getElementById('offerDetailContent');
            content.innerHTML = `
                <h2 class="modal-title">${offer.title}</h2>
                <div class="offer-detail">
                    <p><strong>Empresa:</strong> ${offer.company_name || 'No especificado'}</p>
                    <p><strong>Tipo:</strong> <span class="badge badge-${offer.type}">${offer.type}</span></p>
                    <p><strong>Carrera:</strong> ${offer.career}</p>
                    <p><strong>Fecha L√≠mite:</strong> ${formatDate(offer.deadline)}</p>
                    
                    <h3>Descripci√≥n</h3>
                    <p>${offer.description}</p>
                    
                    <h3>Requisitos</h3>
                    <p>${offer.requirements}</p>
                    
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="applyToOffer(${offer.id}); closeModal('offerModal')">Aplicar Ahora</button>
                        <button class="btn btn-secondary" onclick="closeModal('offerModal')">Cerrar</button>
                    </div>
                </div>
            `;
        }

        async function loadMyApplications() {
            try {
                const status = document.getElementById('applicationStatusFilter').value;
                let applications = await apiGetStudentApplications(currentUser.id);
                
                if (status) {
                    applications = applications.filter(app => app.status === status);
                }
                
                renderMyApplications(applications);
            } catch (error) {
                showNotification('Error al cargar postulaciones', 'error');
            }
        }

        function renderMyApplications(applications) {
            const container = document.getElementById('applicationsContainer');
            if (applications.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: var(--gray-600);"><p style="font-size: var(--font-size-lg); margin: 0;">üì≠ No tienes postulaciones a√∫n</p></div>';
                return;
            }
            
            container.innerHTML = applications.map(app => `
                <div class="application-card">
                    <div class="application-header">
                        <div>
                            <h3 class="application-title">${app.offer_title}</h3>
                            <p style="margin: 4px 0 0 0; font-size: var(--font-size-sm); color: var(--gray-600);">${app.company_name}</p>
                        </div>
                        <span class="application-status status-${app.status}">${getStatusLabel(app.status)}</span>
                    </div>
                    <div class="application-info">
                        <div class="info-row">
                            <strong>üìÖ Aplicado:</strong>
                            <span class="value">${formatDate(app.applied_at)}</span>
                        </div>
                        ${app.assigned_teacher_name ? `
                            <div class="info-row">
                                <strong>üë®‚Äçüè´ Profesor:</strong>
                                <span class="value">${app.assigned_teacher_name}</span>
                            </div>
                        ` : ''}
                        <div class="info-row">
                            <strong>üìå Estado:</strong>
                            <span class="value">${getStatusMessage(app.status)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pendiente',
                'company_accepted': 'Empresa Acept√≥',
                'company_rejected': 'Empresa Rechaz√≥',
                'approved': 'Aprobada',
                'rejected': 'Rechazada'
            };
            return labels[status] || status;
        }

        function getStatusMessage(status) {
            const messages = {
                'pending': '‚è≥ Tu postulaci√≥n est√° siendo revisada por la empresa',
                'company_accepted': '‚úÖ La empresa te acept√≥. Pendiente de aprobaci√≥n del admin y asignaci√≥n de profesor',
                'company_rejected': '‚ùå La empresa rechaz√≥ tu postulaci√≥n',
                'approved': 'üéâ ¬°Felicitaciones! Tu pr√°ctica fue aprobada y tienes un profesor asignado',
                'rejected': '‚ùå Tu postulaci√≥n fue rechazada por el administrador'
            };
            return `<p class="status-message">${messages[status] || ''}</p>`;
        }

        function editProfile() {
            showNotification('Edici√≥n de perfil en desarrollo', 'info');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO');
        }

        function truncate(text, length) {
            if (!text) return '';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }
    </script>
</body>
</html>